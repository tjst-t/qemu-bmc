version: "2.4"

services:
  qemu:
    build:
      context: ..
      dockerfile: integration/Dockerfile.qemu
    volumes:
      - qmp-sock:/shared
    healthcheck:
      test: ["CMD-SHELL", "test -S /shared/qmp.sock"]
      interval: 1s
      timeout: 5s
      retries: 10

  bmc:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    entrypoint: ["/usr/local/bin/qemu-bmc"]
    environment:
      QMP_SOCK: /shared/qmp.sock
      IPMI_USER: admin
      IPMI_PASS: password
      REDFISH_PORT: "443"
      IPMI_PORT: "623"
    volumes:
      - qmp-sock:/shared
    depends_on:
      qemu:
        condition: service_healthy
    ports:
      - "8443:443"
      - "8623:623/udp"

  test:
    build:
      context: ..
      dockerfile: integration/Dockerfile.test
    environment:
      BMC_REDFISH_URL: http://bmc:443
      BMC_IPMI_HOST: bmc
      BMC_USER: admin
      BMC_PASS: password
    depends_on:
      - bmc

volumes:
  qmp-sock:
