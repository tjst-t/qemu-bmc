# qemu-bmc Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a Go single binary that controls QEMU VMs via Redfish API (HTTPS) and IPMI over LAN (UDP:623), replacing docker-qemu-bmc's shell scripts + ipmi_sim + supervisord.

**Architecture:** Single Go binary exposing two network interfaces - Redfish (HTTPS :443) and IPMI (UDP :623) - both backed by a Machine layer that wraps QMP socket communication with QEMU. TDD approach with mock QMP server for unit tests.

**Tech Stack:** Go 1.22+, net/http + gorilla/mux, QMP via unix socket + encoding/json, IPMI RMCP/RMCP+ Go implementation, testing + httptest

---

### Task 1: Project foundation - go mod init and directory structure

**Files:**
- Create: `go.mod`
- Create: `cmd/qemu-bmc/main.go`
- Create: all `internal/` directory stubs

**Step 1:** Initialize Go module and create directory structure
**Step 2:** Create minimal main.go
**Step 3:** Verify `go build ./...` works
**Step 4:** Commit

### Task 2: QMP client - types and interface

**Files:**
- Create: `internal/qmp/types.go`
- Create: `internal/qmp/client.go`
- Test: `internal/qmp/client_test.go`
- Create: `internal/qmp/testutil_test.go`

TDD: Write mock QMP server, write tests for QueryStatus/SystemPowerdown/SystemReset/Quit, implement client.

### Task 3: Machine layer

**Files:**
- Create: `internal/machine/machine.go`
- Test: `internal/machine/machine_test.go`

TDD: Mock QMP client interface, test power state, reset types, boot override.

### Task 4: Config package

**Files:**
- Create: `internal/config/config.go`
- Test: `internal/config/config_test.go`

TDD: Environment variable loading with defaults.

### Task 5: Redfish ServiceRoot

**Files:**
- Create: `internal/redfish/types.go`
- Create: `internal/redfish/server.go`
- Create: `internal/redfish/handler_service_root.go`
- Test: `internal/redfish/server_test.go`

TDD: GET /redfish/v1/ returns proper ServiceRoot JSON.

### Task 6: Redfish Systems

**Files:**
- Create: `internal/redfish/handler_systems.go`
- Test: `internal/redfish/handler_systems_test.go`

TDD: SystemCollection, ComputerSystem with PowerState, Boot, Actions.

### Task 7: Redfish Reset Action

**Files:**
- Create: `internal/redfish/handler_actions.go`
- Test: `internal/redfish/handler_actions_test.go`

TDD: POST ComputerSystem.Reset with all ResetType values.

### Task 8: Redfish Boot Device PATCH

**Files:**
- Modify: `internal/redfish/handler_systems.go`
- Modify: `internal/redfish/handler_systems_test.go`

TDD: PATCH Systems/1 for boot override with ETag support.

### Task 9: Redfish Middleware

**Files:**
- Create: `internal/redfish/middleware.go`
- Test: `internal/redfish/middleware_test.go`

TDD: Basic Auth, trailing slash normalization, ETag handling.

### Task 10: IPMI RMCP parser

**Files:**
- Create: `internal/ipmi/types.go`
- Create: `internal/ipmi/rmcp.go`
- Test: `internal/ipmi/rmcp_test.go`

TDD: Parse/serialize RMCP messages.

### Task 11: IPMI 1.5 session + App handlers

**Files:**
- Create: `internal/ipmi/session.go`
- Create: `internal/ipmi/server.go`
- Create: `internal/ipmi/handler_app.go`
- Test: `internal/ipmi/server_test.go`
- Test: `internal/ipmi/handler_app_test.go`
- Test: `internal/ipmi/session_test.go`

TDD: Get Channel Auth Capabilities, Get Device ID, session management.

### Task 12: RMCP+ (RAKP authentication)

**Files:**
- Create: `internal/ipmi/rmcp_plus.go`
- Test: `internal/ipmi/rmcp_plus_test.go`

TDD: Full RAKP handshake, HMAC-SHA1, session encryption.

### Task 13: IPMI Chassis commands

**Files:**
- Create: `internal/ipmi/handler_chassis.go`
- Test: `internal/ipmi/handler_chassis_test.go`

TDD: Chassis Control, Get Chassis Status, Boot Options.

### Task 14: Redfish Managers + VirtualMedia

**Files:**
- Create: `internal/redfish/handler_managers.go`
- Test: `internal/redfish/handler_managers_test.go`

TDD: Manager resource, VirtualMedia insert/eject.

### Task 15: Redfish Chassis

**Files:**
- Create: `internal/redfish/handler_chassis.go`
- Test: `internal/redfish/handler_chassis_test.go`

TDD: Chassis collection and individual chassis resource.

### Task 16: Main entrypoint integration

**Files:**
- Modify: `cmd/qemu-bmc/main.go`

Wire everything together: config, machine, redfish server, IPMI server, goroutine startup.

### Task 17: Dockerfile

**Files:**
- Create: `Dockerfile`

Multi-stage build for minimal container image.
